# corsika-sim
Repository of scripts for running, processing and analyzing air shower simulations using the Corsika8 framework.

## run.sh
Simple bash script for running Corsika8 simulations. Run with
```bash
bash run.sh [--profile]
```

Inside the file, set the primary particle types (PDG codes) and energies you want to simulate, number of showers in each run and number of runs:

```bash
# Particles to simulate - 22=gamma, 2212=proton
PARTICLES=(2212 22)

# Primary energies to simulate (in GeV), CTA range is 20 GeV - 300 TeV
ENERGIES=(10 100 500)

# Number of showers in each simulation
SHOWERS=1

# Number of runs for each configuration
RUNS=10
```

When run with `--profile` argument, the script runs Corsika8 simulations inside a callgrind wrapper to generate profiling information. This takes approximately 40-60 times as long as running only the simulations. 

## annotate_calls.sh
A bash script to generate textfiles with profiling information for each run. When run, automatically runs over all simulation outputs where callgrind profiling was enabled and generates results using the `callgrind_annotate` tool. Run with
```shell
bash annotate_calls.sh [no arguments]
```

For each run, top `N` costliest functions and their corresponding libraries are listed in the textfile `annotate.txt`, located in the simulation output directory. `N` can be controlled by setting `FUNCS` inside the script:
```python
# Number of costliest functions to annotate
FUNCS=10
```

## plot_annotations.py
Python script to plot profiling output generated by `annotate_calls.sh`. Runs over all simulation outputs where `annotate.txt` is located and generates plots in the `plots/` directory using `matplotlib`. Run with
```shell
python3 plot_annotations.py [no arguments]
```

## merge_outputs.py
Python script to merge parquet output files from multiple simulation runs into a single file (for each directory that Corsika8 outputs). Run with 
```shell
python3 merge_outputs.py [simulation_name]
```
E.g. for a 100 GeV gamma simulation performed using the `run.sh` script, type
```shell
python3 merge_outputs.py pdg22_E100
```

The script creates a directory `merged/` inside the simulation output directory and places all the merged parquet files there.
